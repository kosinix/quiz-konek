{% extends "document-exam.html" %}

{% block body %}
<div id="vApp" v-cloak>
    <template v-if="page<3">
        <div class="container">
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8 ">
                    
                    <template v-if="page==1">
                        <div class="text-center mt-5">
                            <h1 class="h1"><img width="250px" src="/images/logo.png" alt="QuizKonek"></h1>
                            <h6 class="h5">The Paperless Exam App</h6>
                            <p class=" mb-4"><em>By Nico Amarilla</em></p>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-center pt-5">
                                <div class="d-flex align-items-center">
                                    <label for="name" class="flex-grow-1 m-0 text-right">Your Name</label>
                                    <div class="ml-2 mr-2">
                                        <select v-model="name" name="name" id="name" class="form-control">
                                            <option value=""></option>
                                            <option v-for="e in examSession.examinees" :value="e">${e.lastName}, ${e.firstName}</option>
                                        </select>
                                    </div>
                                    <div class="">
                                        <button @click="onReady" :disabled="disabled" class="btn btn-success">Take Exam</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template v-if="page==2">
                        <div class="row">
                            <div class="col-md-12 pt-5">
                                <h1 class="h2 text-center mb-5">Exam: ${exam.title}</h1>
                                <div class="form-row mb-2">
                                    <div class="col-4">
                                        <h3 class="h5 text-center">Total</h3>
                                        <div class="text-center">
                                            <svg width="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>List</title><path fill="#0081db" d="M11 15H17V17H11V15M9 7H7V9H9V7M11 13H17V11H11V13M11 9H17V7H11V9M9 11H7V13H9V11M21 5V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3H19C20.1 3 21 3.9 21 5M19 5H5V19H19V5M9 15H7V17H9V15Z" /></svg>
                                        </div>
                                        <p class="text-center">${exam.questions.length} items <br></p>

                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <h3 class="h5 text-center">Time</h3>
                                            <svg width="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Time</title><path fill="#0081db" d="M12 20C16.4 20 20 16.4 20 12S16.4 4 12 4 4 7.6 4 12 7.6 20 12 20M12 2C17.5 2 22 6.5 22 12S17.5 22 12 22C6.5 22 2 17.5 2 12C2 6.5 6.5 2 12 2M12.5 12.8L7.7 15.6L7 14.2L11 11.9V7H12.5V12.8Z" /></svg>
                                        </div>
                                        <p class="text-center">${exam.questions.length} minutes</p>
                                    </div>
                                    <div class="col-4">
                                        <h3 class="h5 text-center">Rules</h3>
                                        <div class="text-center">
                                            <svg width="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Rules</title><path fill="#0081db" d="M12,3C10.73,3 9.6,3.8 9.18,5H3V7H4.95L2,14C1.53,16 3,17 5.5,17C8,17 9.56,16 9,14L6.05,7H9.17C9.5,7.85 10.15,8.5 11,8.83V20H2V22H22V20H13V8.82C13.85,8.5 14.5,7.85 14.82,7H17.95L15,14C14.53,16 16,17 18.5,17C21,17 22.56,16 22,14L19.05,7H21V5H14.83C14.4,3.8 13.27,3 12,3M12,5A1,1 0 0,1 13,6A1,1 0 0,1 12,7A1,1 0 0,1 11,6A1,1 0 0,1 12,5M5.5,10.25L7,14H4L5.5,10.25M18.5,10.25L20,14H17L18.5,10.25Z" /></svg>
                                        </div>
                                        <ul>
                                            <li>Multiple choice</li>
                                            <li>No tab switching</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <h1 class="h3 mt-5 text-success text-center">Get ready for the exam...</h1>

                            </div>
                        </div>
                    </template>
                </div>
                <div class="col-md-2"></div>
            </div>
        </div>
    </template>
    <template v-if="page>=3">
        <header>
            <nav class="container">
                <div class="row">
                    <div class="col-12 pt-3 pb-3">
                        <h1 class="h1 text-center">HTML Quiz 1</h1>
                    </div>
                </div>
            </nav>
        </header>
        <div class="container">
            <div class="row">
                <div class="col-12 pt-5 pb-5">
                    <ol class="questions">
                        <li v-for="(question, questionIndex) in exam.questions">
                            <div class="body">
                                <span class="bullet">${questionIndex + 1}.</span>
                                <p>${question.text}</p>
                            </div>
                            <ol class="choices">
                                <template v-for="(choice, choiceIndex) in question.choices">
                                    <li @click="selectChoice(questionIndex, choiceIndex)"
                                        :data-selected="question.selected === choiceIndex">
                                        <span class="letter">${getAlphabet(choiceIndex)}.</span>
                                        <span>${choice}</span>
                                    </li>
                                </template>
                            </ol>
                        </li>
                    </ol>
                    <p>${answers}</p>
                </div>
            </div>
        </div>
    </template>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{app.url}}/js/socket.io.min.js"></script>
<script>
    let socket = io("{{SOCKET_URL}}/quiz", {
        query: {
            room: 'room-{{examSession.id}}',
        }
    });
    var examSession = {{ examSession|default({}, true) | stringify | safe}};
    var exam = {{ exam|default({}, true) | stringify | safe}};
    var vApp = new Vue({
        el: '#vApp',
        delimiters: ["${", "}"],
        mixins: [],
        data: {
            pending: false,
            play: false,
            page: 1,
            name: '',
            examSession: examSession,
            exam: exam,
        },
        computed: {
            answers: function(){
                var me = this;
                return me.exam.questions.map( a => {
                    return {
                        question: a.text,
                        selected: me.getAlphabet(a.selected)
                    }
                })
            },
            disabled: function(){
                var me = this;
                return `${me.name}`.trim() !== '' ? false : true
            }
        },
        mounted: function () {
            var me = this;

            // me.page = 3
            // client-side
            socket.on("connect", () => {
                me.connected = true
                console.log('connected ', socket.id); // x8WIv7-mJelg7on_ALbx
            });

            socket.on("disconnect", () => {
                me.connected = false
                console.log('disconnected ', socket.id); // undefined
            });
            
            socket.on("connect_error", (err) => {
                console.error(err.message);
            });
            
            socket.on('updateUi', (payload) => {
                console.log('updateUi: ', payload);
                me.page = payload.page
            });
            // socket.on("updateThreadMessages", async (payload) => {
            //     console.log('updateThreadMessages', payload)
            //     me.messages = payload.messages
            // });
            // socket.on("updateMessage", async (payload) => {
            //     console.log('updateMessage', payload)
                
            //     let index = _.findIndex(me.messages, function(m){
            //         return m.uuid == payload.message.uuid
            //     })
            //     if(index < 0){
            //         me.messages.push(payload.message)

            //     } else {
            //         me.messages[index].content += payload.message.content

            //     }
            // });
        },
        methods: {
            onReady: function () {
                var me = this;
                socket.emit("studentReady", {
                    student: me.name,
                });
                // document.documentElement.requestFullscreen();
                me.page = 2
            },
            getAlphabet: function (choiceIndex) {
                let alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')
                return alphabet[choiceIndex]
            },
            selectChoice: function (questionIndex, choiceIndex) {
                const me = this;
                if (me.exam.questions[questionIndex].selected === choiceIndex) {
                    me.exam.questions[questionIndex].selected = -1
                } else {
                    me.exam.questions[questionIndex].selected = choiceIndex
                }
            }
        }
    });


    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            socket.emit("fullScreen", "requestFullscreen");
        } else if (document.exitFullscreen) {
            document.exitFullscreen();
            socket.emit("fullScreen", "exitFullscreen");

        }
    }

    // document.addEventListener('visibilitychange', function () {
    //     if (document.hidden) {
    //         console.log('leaving tab is not allowed!');
    //     } else {
    //         // console.log('well back');
    //     }
    // }, false);

    // document.addEventListener('contextmenu', event => event.preventDefault());

    // window.addEventListener('beforeunload', function (e) {
    //     // Cancel the event
    //     e.preventDefault(); // If you prevent default behavior in Mozilla Firefox prompt will always be shown
    //     // Chrome requires returnValue to be set
    //     e.returnValue = '';
    // });
</script>
{% endblock %}